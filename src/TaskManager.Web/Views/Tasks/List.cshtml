@using TaskManager.Web.Models.Tasks
@using TaskManager.Consts;
@model ListTaskPageViewModel

@{
    ViewData["Title"] = "Список задач";

    var reviewers = Model.Users
        .Where(u => u.Value.Role == UserRoles.Senior)
        .Select(u => new { u.Key, u.Value })
        .ToList();
    
    var testers = Model.Users
        .Where(u => u.Value.Role == UserRoles.Tester)
        .Select(u => new { u.Key, u.Value })
        .ToList();
}

<div class="main-content">
    <div style="margin-bottom: 20px;">
        <button class="btn" onclick="document.getElementById('createModal').style.display='block'">Создать задачу</button>
    </div>

    <div class="container">
        <h1>Мои задачи</h1>

        @if (!Model.Tasks.Any())
        {
            <p>Задачи отсутствуют.</p>
        }
        else
        {
            <div class="content">
            @foreach (var task in Model.Tasks)
            {
                <div class="task-card">
                    <div class="task-title">@task.Title</div>
                    <div class="task-meta">
                    <span>Deadline: @task.Deadline.ToString("dd.MM.yyyy")</span>
                    </div>
                    <form asp-controller="Tasks" asp-action="Details" method="get">
                        <input type="hidden" name="id" value="@task.TaskId" />
                        <button class="btn" type="submit">Подробнее</button>
                    </form>
                </div>
            }
            </div>
        }
    </div>
</div>

<div id="createModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div class="auth-form-container" style="margin: 50px auto;">
        <h2>Создать задачу</h2>
        <form asp-controller="Tasks" asp-action="Create" method="post">
            <div>
                <label>Название:</label><br />
                <input type="text" name="Title" class="form-control" required minlength="3" maxlength="255" />
            </div>
            <div>
                <label>Описание:</label><br />
                <textarea name="Description" class="form-control" required minlength="3" maxlength="255"></textarea>
            </div>
            <div>
                <label>Дедлайн:</label><br />
                <input type="date" name="DeadLine" class="form-control" />
            </div>
            <div>
                <label>Ревьюер</label><br />
                <select name="ReviewerId" class="form-control">
                    <option value="">Выберите ревьюера</option>
                    @foreach (var reviewer in reviewers)
                    {
                        <option value="@reviewer.Key">@reviewer.Value.Username</option>
                    }
            </div>
            <div>
                <label>Тестировщик</label><br />
                <select name="TesterId" class="form-control">
                    <option value="">Выберите тестировщика</option>
                    @foreach (var tester in testers)
                    {
                        <option value="@tester.Key">@tester.Value.Username</option>
                    }
            </div>
            <div>
                <label>Назначен на:</label><br />
                <select name="AssignedToId" class="form-control">
                    <option value="">Выберите исполнителя</option>
                    @foreach (var user in Model.Users)
                    {
                        <option value="@user.Key">@user.Value.Username</option>
                    }
            </div>
            <div>
                <label>ID Проекта:</label><br />
                <select name="ProjectId" class="form-control">
                    <option value="">Выберите проект</option>
                    @foreach (var project in Model.Projects)
                    {
                        <option value="@project.ProjectId">@project.ShortName</option>
                    }
            </div>
            <br />
            <button type="submit" class="btn">Создать</button>
            <button type="button" class="btn" style="background:#95a5a6;" onclick="document.getElementById('createModal').style.display='none'">Отмена</button>
        </form>
    </div>
</div>


@functions {
    string GetStatusClass(string status) => status switch
    {
        "New" => "status-new",
        "InProgress" => "status-in-progress",
        "Done" => "status-done",
        _ => ""
    };
}
